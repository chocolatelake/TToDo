最新のコード（エラーハンドリング追加・リスト表示ロジック修正・ボタン連打対策済み）に基づいた、**バージョン 2.1.0** の仕様書を作成しました。

「ゾンビプロセス（二重起動）」への注意書きも運用項目に追加しています。

---

# Discord用 ToDo管理ボット（TToDo） 仕様書

**システム名:** TToDo (Text-based ToDo Bot)
**バージョン:** 2.1.0
**作成日:** 2025/12/19
**開発言語:** C# (.NET 9.0)

## 1. システム概要

本システムは、Discordのテキストチャンネルをインターフェースとしたタスク管理ボットである。
チャット感覚でタスクを登録し、ボタン操作でステータス（完了・後回し・忘却）を管理する。独自の「スマート解析」により、箇条書きテキストを自動的に「タスク」と「詳細メモ」に構造化する機能を特徴とする。

## 2. 動作環境

* **OS:** Windows 10 / 11
* **実行環境:** .NET 9.0 Runtime
* **プラットフォーム:** Discord (Botアカウント)
* **依存ライブラリ:** Discord.Net

## 3. 機能仕様

### 3.1 タスク登録 (スマート解析)

* **コマンド:** `!ttodo [テキスト]`
* **ロジック:** 複数行のテキストを行ごとに解析する。
* **親タスク:** 通常の行は新規タスクとして登録される。
* **メモ結合:** 行頭が「区切り文字（Prefix）」で始まる場合、直前の親タスクに改行付きで結合される。
* *デフォルトPrefix:* 半角スペース, 全角スペース, タブ, `・`, `→`, `：`, `:`



### 3.2 状態管理 (3ステート)

タスクは以下の3つの状態を持ち、ボタン操作で遷移する。

1. **アクティブ (Active):**
* 現在進行中のタスク。
* 表示: `!ttodo list` および `!ttodo` 投稿時。
* ボタン: `[完了！]` `[後回し]` `[忘れる]`


2. **後回し (Snoozed):**
* 一時的に保留中のタスク。
* 表示: `!ttodo list` には表示される。次回 `!ttodo` 投稿時に自動的に再通知される。
* ボタン: `[完了！]` (表示は `💤 ~~タスク名~~`)


3. **忘却 (Forgotten):**
* アーカイブされたタスク（視界から消したいもの）。
* 表示: `!ttodo forgot` コマンドでのみ表示される。
* ボタン: `[思い出す]` `[抹消]`



### 3.3 データ永続化

* データはローカルのテキストファイルにリアルタイムで保存される。
* Bot再起動後もタスク状態、ユーザー設定は維持される。

### 3.4 安定性・エラーハンドリング

* **Interaction Timeout対策:** Discordの「3秒ルール」によるクラッシュを防ぐため、UI更新処理のエラーを `try-catch` で捕捉し、プロセスを落とさずにログ出力のみに留める設計とする。

## 4. コマンド一覧

| コマンド | 引数 | 説明 |
| --- | --- | --- |
| **`!ttodo`** | `[テキスト]` | テキストを解析し、タスクとして一括登録する。 |
| **`!ttodo`** | `list` | 現在のタスク一覧（アクティブ＋後回し）を表示する。 |
| **`!ttodo`** | `forgot` | 「忘れる」状態にしたタスク一覧を表示する。 |
| **`!ttodo`** | `backup` | 全タスクデータを復元可能なテキスト形式で出力する。 |
| **`!tset`** | `list` | 現在のPrefix設定を編集用コマンド形式で表示する。 |
| **`!tset`** | `setall [..]` | Prefix設定を一括更新する。 |
| **`!tset`** | `add [文字]` | 指定した文字をPrefixに追加する。 |
| **`!tset`** | `del [文字]` | 指定した文字をPrefixから削除する。 |
| **`!tset`** | `reset` | Prefix設定を初期状態に戻す。 |

## 5. UI / ボタン遷移仕様

### 5.1 通常パネル (Active)

> 📝 **ToDo:**
> **タスク名** (メモ含む)
> `[完了！(緑)]` `[後回し(灰)]` `[忘れる(赤)]`

* **完了:** データ削除 → `✅ ~~タスク名~~` に更新 → ボタン消去。
* **後回し:** フラグON → `💤 ~~タスク名~~` に更新 → `[完了！]` ボタンのみ残す。
* **忘れる:** フラグON → `🌫️ ~~タスク名~~ (忘却リストへ)` に更新 → ボタン消去。

### 5.2 忘却パネル (Forgotten)

> 🌫️ **[忘却]**
> **タスク名**
> `[思い出す(青)]` `[抹消(赤)]`

* **思い出す:** フラグOFF → メッセージ削除 → 「💡思い出しました！」と共に通常パネルを新規投稿。
* **抹消:** データ完全削除 → `🗑️ ~~タスク名~~ (抹消済み)` に更新 → ボタン消去。

## 6. データ構造

実行ファイルと同階層に以下の形式で保存する。

### `tasks.txt`

各行が1タスクに対応。区切り文字は `|`。

* **フォーマット:** `UserID|IsSnoozed|IsForgotten|ID|Content`
* `UserID`: ulong (Discord ID)
* `IsSnoozed`: bool (True/False)
* `IsForgotten`: bool (True/False)
* `ID`: string (UUID)
* `Content`: string (改行は `<<NL>>` に置換)



### `prefixes.txt`

各行が1ユーザーの設定に対応。

* **フォーマット:** `UserID|Prefix1\tPrefix2\t...`

## 7. 運用手順と注意点

### 7.1 起動・更新

1. **ビルド:** Visual Studio にて `Release` モードでビルドを行う。
2. **配置:** 生成された `DisCord.exe` を任意のフォルダへ配置（または上書き）する。
3. **起動:** `DisCord.exe` をダブルクリックして実行する。

### 7.2 二重起動の禁止 (重要)

* **現象:** Botが2回反応する、エラーが出るなど。
* **原因:** 以前のプロセスが裏で残ったまま、新しいBotを起動した場合に発生する。
* **対策:** 更新や再起動の際は、必ずタスクマネージャー等で既存の `DisCord.exe` プロセスが終了していることを確認すること。

### 7.3 バックアップ

* `tasks.txt` をコピーするか、Bot上で `!ttodo backup` コマンドを実行することで、テキストベースのバックアップを取得可能。