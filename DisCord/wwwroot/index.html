<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TToDo Kanban</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="app" class="app-container">
        <header>
            <div class="header-left">
                <h1>TToDo Board</h1>
            </div>

            <div class="header-controls">
                <button class="btn-sort" @click="openCreateModal" style="color:var(--primary-color); border-color:var(--primary-color);">＋ 新規タスク</button>
                <span class="divider">|</span>
                <button class="btn-sort" @click="openReportModal">📋 日報作成</button>
                <span class="divider">|</span>
                <button class="btn-sort" @click="showFilterMenu = !showFilterMenu">🔍 絞り込み</button>
                <span class="divider">|</span>
                <button v-if="userId" class="btn-sort" @click="openBatchChannelModal">📡 送信先一括</button>
                <span class="sort-label">順序:</span>
                <button class="btn-sort" :class="{active: sortMode==='priority'}" @click="sortMode='priority'">🔥</button>
                <button class="btn-sort" :class="{active: sortMode==='category'}" @click="sortMode='category'">🏷️</button>
            </div>
        </header>

        <div v-if="showFilterMenu" class="filter-panel">
            <div class="filter-section">
                <span class="filter-title">ユーザー:</span>
                <button v-for="u in uniqueUsers" :key="u" class="chip" :class="{selected: filterUsers.includes(u)}" @click="toggleFilterUser(u)">{{ u }}</button>
                <button class="chip" @click="filterUsers = []" v-if="filterUsers.length > 0">クリア</button>
            </div>
            <div class="filter-section">
                <span class="filter-title">チャンネル:</span>
                <button v-for="c in uniqueChannels" :key="c" class="chip" :class="{selected: filterChannels.includes(c)}" @click="toggleFilterChannel(c)">{{ c }}</button>
                <button class="chip" @click="filterChannels = []" v-if="filterChannels.length > 0">クリア</button>
            </div>
        </div>

        <div v-if="loading" style="text-align:center">Loading...</div>

        <div v-else class="kanban-board">
            <div class="column col-todo" @dragover.prevent @drop="onDrop($event, 'active')">
                <div class="column-header">🚀 進行中 <span class="count">{{ tasksActive.length }}</span></div>
                <div class="task-container">
                    <div v-for="task in tasksActive" :key="task.id" class="card p-border" :class="getPrioClass(task)"
                         draggable="true" @dragstart="onDragStart($event, task)" @click="openEdit(task)">
                        <div class="card-header">
                            <img v-if="task.avatarUrl" :src="task.avatarUrl" class="user-avatar" :title="task.assignee || task.userName">
                            <span v-else class="user-badge">{{ task.assignee || task.userName }}</span>
                        </div>
                        <div class="task-content">
                            <div class="tags">
                                <span class="tag server-tag" v-if="task.guildName">🏢 {{ task.guildName }}</span>
                                <span class="tag channel-tag" v-if="task.channelName"># {{ task.channelName }}</span>
                                <span v-for="tag in task.tags" class="tag">#{{ tag }}</span>
                                <span v-if="task.priority > -1" class="tag prio-tag">{{ getPrioLabel(task) }}</span>
                            </div>
                            <div class="text">{{ task.content }}</div>
                        </div>
                        <div class="actions">
                            <button class="btn-icon btn-check" @click.stop="moveToDone(task)">✔</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="column col-done" @dragover.prevent @drop="onDrop($event, 'done')">
                <div class="column-header">✅ 完了 <span class="count">{{ tasksDone.length }}</span></div>
                <div class="task-container">
                    <div v-for="task in tasksDone" :key="task.id" class="card done-card"
                         draggable="true" @dragstart="onDragStart($event, task)" @click="openEdit(task)">
                        <div class="card-header">
                            <img v-if="task.avatarUrl" :src="task.avatarUrl" class="user-avatar" :title="task.assignee || task.userName">
                            <span v-else class="user-badge">{{ task.assignee || task.userName }}</span>
                        </div>
                        <div class="task-content">
                            <div class="tags">
                                <span class="tag time-tag">{{ formatTime(task.completedAt) }}</span>
                                <span class="tag server-tag" v-if="task.guildName">🏢 {{ task.guildName }}</span>
                                <span class="tag channel-tag" v-if="task.channelName"># {{ task.channelName }}</span>
                            </div>
                            <div class="text">{{ task.content }}</div>
                        </div>
                        <div class="actions">
                            <button class="btn-icon btn-return" @click.stop="moveToActive(task)">↩️</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="column col-archive" @dragover.prevent @drop="onDrop($event, 'archive')">
                <div class="column-header">
                    <div>🗑️ アーカイブ <span class="count">{{ tasksArchive.length }}</span></div>
                    <button class="btn-icon-small" @click="cleanupArchive"
                            :title="filterUsers.length > 0 ? '表示中のユーザーのアーカイブを削除' : '全ユーザーのアーカイブを削除'"
                            v-if="tasksArchive.length > 0" style="color: #cf513d;">
                        {{ filterUsers.length > 0 ? '🗑️表示分削除' : '🗑️全削除' }}
                    </button>
                </div>
                <div class="task-container">
                    <div v-for="task in tasksArchive" :key="task.id" class="card archive-card"
                         draggable="true" @dragstart="onDragStart($event, task)" @click="openEdit(task)">
                        <div class="card-header">
                            <img v-if="task.avatarUrl" :src="task.avatarUrl" class="user-avatar" :title="task.assignee || task.userName">
                            <span v-else class="user-badge">{{ task.assignee || task.userName }}</span>
                        </div>
                        <div class="task-content">
                            <div class="text">{{ task.content }}</div>
                        </div>
                        <div class="actions">
                            <button class="btn-icon btn-restore" @click.stop="moveToActive(task)">♻️</button>
                            <button class="btn-icon btn-delete" @click.stop="deleteTask(task)">💥</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="editForm" class="modal-overlay" @click.self="editForm = null">
            <div class="modal">
                <h3>{{ isCreating ? '新規タスク' : 'タスク編集' }}</h3>
                <div class="form-group"><label>内容</label><textarea class="form-control" rows="3" v-model="editForm.content"></textarea></div>

                <div class="form-group">
                    <label>担当者 (Assignee)</label>
                    <input type="text" class="form-control" v-model="editForm.assignee" list="assigneeList" placeholder="名前を入力...">
                    <datalist id="assigneeList">
                        <option v-for="name in allAssignees" :value="name"></option>
                    </datalist>
                </div>

                <div class="form-group">
                    <label>送信先 (サーバー / チャンネル)</label>
                    <div class="row">
                        <select class="form-control" v-model="editForm.guildName" @change="editForm.channelName = ''">
                            <option value="">(未設定)</option>
                            <option v-for="g in existingGuilds" :value="g">{{ g }}</option>
                        </select>
                        <span style="align-self:center">/</span>
                        <select class="form-control" v-model="editForm.channelName">
                            <option value="">(未設定)</option>
                            <option v-for="c in getChannelsForGuild(editForm.guildName)" :value="c">{{ c }}</option>
                        </select>
                    </div>
                </div>

                <div class="form-group"><label>タグ</label><input type="text" class="form-control" v-model="editForm.tagsStr"></div>
                <div class="form-group">
                    <label>優先度</label>
                    <div class="chip-group">
                        <div class="chip" :class="{selected: editForm.priority===1}" @click="editForm.priority=1">重要</div>
                        <div class="chip" :class="{selected: editForm.priority===0}" @click="editForm.priority=0">普通</div>
                        <div class="chip" :class="{selected: editForm.priority===-1}" @click="editForm.priority=-1">なし</div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-cancel" @click="editForm = null">キャンセル</button>
                    <button class="btn btn-save" @click="saveTask">保存</button>
                </div>
            </div>
        </div>

        <div v-if="showReportModal" class="modal-overlay" @click.self="showReportModal = false">
            <div class="modal" style="max-width: 500px;">
                <h3>📋 日報抽出</h3>

                <div class="form-group">
                    <label>対象ユーザー</label>
                    <select class="form-control" v-model="reportForm.targetUser" @change="updateReportPreview">
                        <option v-for="u in uniqueUsers" :value="u">{{ u }}</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>プレビュー (コピー可)</label>
                    <textarea class="form-control" rows="6" readonly>{{ reportPreview }}</textarea>
                    <button class="btn-icon-small" @click="copyReport" style="margin-top:5px;">📋 コピー</button>
                </div>

                <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

                <div class="form-group">
                    <label>Discordへ送信</label>
                    <div class="row">
                        <select class="form-control" v-model="reportForm.guildName" @change="reportForm.channelName = ''">
                            <option value="">サーバー選択</option>
                            <option v-for="g in existingGuilds" :value="g">{{ g }}</option>
                        </select>
                        <select class="form-control" v-model="reportForm.channelName">
                            <option value="">チャンネル選択</option>
                            <option v-for="c in getChannelsForGuild(reportForm.guildName)" :value="c">{{ c }}</option>
                        </select>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-cancel" @click="showReportModal = false">閉じる</button>
                    <button class="btn btn-save" @click="sendReport">📤 送信</button>
                </div>
            </div>
        </div>

        <div v-if="showBatchModal" class="modal-overlay" @click.self="showBatchModal = false">
            <div class="modal" style="max-width: 450px;">
                <h3>📡 送信先の一括変更</h3>
                <p style="font-size:0.9rem; color:#555;">あなたの<b>「アーカイブ以外の全タスク」</b>の日報送信先を、以下に変更します。</p>
                <div class="form-group">
                    <label>サーバー</label>
                    <select class="form-control" v-model="batchForm.guildName" @change="batchForm.channelName = ''">
                        <option disabled value="">選択してください</option>
                        <option v-for="g in existingGuilds" :value="g">{{ g }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>チャンネル</label>
                    <select class="form-control" v-model="batchForm.channelName">
                        <option disabled value="">選択してください</option>
                        <option v-for="c in getChannelsForGuild(batchForm.guildName)" :value="c">{{ c }}</option>
                    </select>
                </div>
                <div style="font-size:0.8rem; color:#e00; margin-bottom:15px;" v-if="batchError">{{ batchError }}</div>
                <div class="modal-actions">
                    <button class="btn btn-cancel" @click="showBatchModal = false">キャンセル</button>
                    <button class="btn btn-save" @click="submitBatchChannel">一括適用</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue
        createApp({
            data() {
                return {
                    tasks: [], loading: true, editForm: null, isCreating: false,
                    sortMode: 'priority', userId: null, myUserId: null,
                    showBatchModal: false, batchForm: { guildName: '', channelName: '' }, batchError: '',
                    showReportModal: false, reportForm: { targetUser: '', guildName: '', channelName: '' }, reportPreview: '',
                    showFilterMenu: false, filterUsers: [], filterChannels: []
                }
            },
            computed: {
                allAssignees() {
                    const fromTasks = this.tasks.map(t => t.assignee).filter(n => n);
                    const creators = this.tasks.map(t => t.userName).filter(n => n);
                    return [...new Set([...fromTasks, ...creators])].sort();
                },
                uniqueUsers() { return [...new Set(this.tasks.map(t => t.userName).filter(n => n))].sort(); },
                uniqueChannels() { return [...new Set(this.tasks.map(t => t.guildName + ' / ' + t.channelName).filter(n => n.length > 3))].sort(); },
                existingGuilds() { return [...new Set(this.tasks.map(t => t.guildName).filter(n => n))].sort(); },

                myUserName() {
                    if (!this.myUserId) return null;
                    const myTask = this.tasks.find(t => t.userId == this.myUserId);
                    return myTask ? myTask.userName : null;
                },

                filteredTasks() {
                    return this.tasks.filter(t => {
                        if (this.filterUsers.length > 0 && !this.filterUsers.includes(t.userName)) return false;
                        if (this.filterChannels.length > 0) {
                            const key = t.guildName + ' / ' + t.channelName;
                            if (!this.filterChannels.includes(key)) return false;
                        }
                        return true;
                    });
                },
                tasksActive() { return this.applySort(this.filteredTasks.filter(t => !t.isForgotten && !t.completedAt)); },
                tasksDone() {
                    const list = this.filteredTasks.filter(t => !t.isForgotten && t.completedAt);
                    return this.sortMode === 'priority' ? list.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt)) : this.applySort(list);
                },
                tasksArchive() { return this.filteredTasks.filter(t => t.isForgotten); }
            },
            mounted() {
                const p = new URLSearchParams(window.location.search);
                const uid = p.get('uid');
                if (uid) {
                    this.myUserId = uid;
                    localStorage.setItem('ttodo_uid', uid);
                    window.history.replaceState({}, '', window.location.pathname);
                } else {
                    this.myUserId = localStorage.getItem('ttodo_uid');
                }
                this.userId = this.myUserId;
                this.fetchTasks();
                setInterval(this.fetchTasks, 3000);
            },
            methods: {
                async fetchTasks() {
                    if (this.editForm || this.showBatchModal || this.showReportModal) return;
                    try { const r = await fetch('/api/tasks'); this.tasks = await r.json(); this.loading = false; } catch { }
                },
                getChannelsForGuild(guildName) {
                    if (!guildName) return [];
                    return [...new Set(this.tasks.filter(t => t.guildName === guildName).map(t => t.channelName).filter(n => n))].sort();
                },
                toggleFilterUser(u) {
                    if (this.filterUsers.includes(u)) this.filterUsers = this.filterUsers.filter(x => x !== u);
                    else this.filterUsers.push(u);
                },
                toggleFilterChannel(c) {
                    if (this.filterChannels.includes(c)) this.filterChannels = this.filterChannels.filter(x => x !== c);
                    else this.filterChannels.push(c);
                },
                openBatchChannelModal() {
                    const lastTask = this.tasksActive.length > 0 ? this.tasksActive[0] : null;
                    this.batchForm = {
                        guildName: lastTask ? lastTask.guildName : '',
                        channelName: lastTask ? lastTask.channelName : ''
                    };
                    this.batchError = '';
                    this.showBatchModal = true;
                },
                async submitBatchChannel() {
                    if (!this.batchForm.guildName || !this.batchForm.channelName) { this.batchError = '選択してください'; return; }
                    try {
                        const payload = { ...this.batchForm, userId: this.myUserId };
                        await fetch('/api/batch/channel', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        this.showBatchModal = false; alert('変更しました'); this.fetchTasks();
                    } catch (e) { this.batchError = 'エラー'; }
                },
                async cleanupArchive() {
                    const targets = this.filterUsers;
                    let msg = '';
                    if (targets.length > 0) msg = `現在絞り込まれている以下のユーザーのアーカイブのみを削除します。\n対象: ${targets.join(', ')}`;
                    else msg = 'すべてのユーザーのアーカイブを完全に削除します。\n（絞り込みを行っていません）';
                    if (!confirm(msg + '\n\nこの操作は取り消せません。よろしいですか？')) return;
                    await fetch('/api/archive/cleanup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ targetUserNames: targets })
                    });
                    this.fetchTasks();
                },

                openCreateModal() {
                    this.isCreating = true;
                    this.editForm = {
                        content: '',
                        priority: -1,
                        difficulty: -1,
                        tagsStr: '',
                        assignee: this.myUserName || '',
                        userName: this.myUserName || '',
                        guildName: '',
                        channelName: ''
                    };
                },
                openEdit(task) {
                    this.isCreating = false;
                    this.editForm = { ...task, tagsStr: task.tags.join(', ') };
                },
                async saveTask() {
                    if (!this.editForm.content) { alert('内容を入力してください'); return; }

                    const payload = {
                        ...this.editForm,
                        tags: this.editForm.tagsStr.split(',').map(s => s.trim()).filter(s => s)
                    };

                    if (this.isCreating) {
                        if (this.myUserId) payload.userId = this.myUserId;
                        else {
                            const u = this.tasks.find(t => t.userName === payload.userName);
                            if (u) payload.userId = u.userId;
                        }
                    }

                    const url = this.isCreating ? '/api/create' : '/api/update';
                    await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    this.editForm = null;
                    this.fetchTasks();
                },

                // ★追加: 日報関連
                openReportModal() {
                    // 初期ターゲット: 絞り込み中ならそのユーザー、自分がいれば自分、いなければリストの先頭
                    let target = '';
                    if (this.filterUsers.length === 1) target = this.filterUsers[0];
                    else if (this.myUserName) target = this.myUserName;
                    else if (this.uniqueUsers.length > 0) target = this.uniqueUsers[0];

                    this.reportForm = {
                        targetUser: target,
                        guildName: '',
                        channelName: ''
                    };
                    this.updateReportPreview();
                    this.showReportModal = true;
                },
                updateReportPreview() {
                    const u = this.reportForm.targetUser;
                    if (!u) { this.reportPreview = '(ユーザーを選択してください)'; return; }

                    // 今日の0時以降に完了したタスクを抽出
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const completed = this.tasks
                        .filter(t => t.userName === u && t.completedAt && new Date(t.completedAt) >= today)
                        .sort((a, b) => new Date(a.completedAt) - new Date(b.completedAt));

                    if (completed.length === 0) {
                        this.reportPreview = `📭 Daily Report: ${u}\n本日の完了タスクはありません。`;
                    } else {
                        const lines = completed.map(t => `・[${this.formatTime(t.completedAt)}] ${t.content}`);
                        this.reportPreview = `📊 Daily Report: ${u}\n本日 ${completed.length}件 完了！\n\n` + lines.join('\n');
                    }
                },
                copyReport() {
                    navigator.clipboard.writeText(this.reportPreview);
                    alert('コピーしました！');
                },
                async sendReport() {
                    if (!this.reportForm.targetUser || !this.reportForm.guildName || !this.reportForm.channelName) {
                        alert('送信先を選択してください'); return;
                    }
                    if (!confirm('Discordに送信しますか？')) return;

                    await fetch('/api/report/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userName: this.reportForm.targetUser,
                            guildName: this.reportForm.guildName,
                            channelName: this.reportForm.channelName
                        })
                    });
                    this.showReportModal = false;
                    alert('送信しました！');
                },

                onDragStart(evt, t) { evt.dataTransfer.dropEffect = 'move'; evt.dataTransfer.effectAllowed = 'move'; evt.dataTransfer.setData('taskId', t.id); },
                onDrop(evt, s) { const id = evt.dataTransfer.getData('taskId'); const t = this.tasks.find(x => x.id === id); if (t) { if (s === 'active') this.moveToActive(t); else if (s === 'done') this.moveToDone(t); else this.moveToArchive(t); } },
                async moveToDone(t) { if (t.isForgotten) await this.post('/api/restore', t); if (!t.completedAt) { t.completedAt = new Date().toISOString(); await this.post('/api/done', t); } },
                async moveToActive(t) { if (t.isForgotten) await this.post('/api/restore', t); if (t.completedAt) { t.completedAt = null; await this.post('/api/done', t); } },
                async moveToArchive(t) { if (!t.isForgotten) { t.isForgotten = true; await this.post('/api/archive', t); } },
                async deleteTask(t) { if (confirm('完全削除しますか？')) await this.post('/api/delete', t); },
                async post(u, d) { await fetch(u, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) }); this.fetchTasks(); },
                applySort(l) { if (this.sortMode === 'category') { return l.sort((a, b) => ((a.tags[0] || 'z').localeCompare(b.tags[0] || 'z')) || (this.getScore(b) - this.getScore(a))); } return l.sort((a, b) => this.getScore(b) - this.getScore(a)); },
                getScore(t) { return (t.priority === 1 ? 10 : t.priority === 0 ? 5 : 1); },
                getPrioLabel(t) { return t.priority === 1 ? '重要' : (t.priority === 0 ? '普通' : ''); },
                getPrioClass(t) { return t.priority === 1 ? (t.difficulty === 1 ? 'p-1' : 'p-2') : (t.priority === 0 ? (t.difficulty === 1 ? 'p-3' : 'p-4') : 'p-0'); },
                formatTime(iso) { if (!iso) return ''; const d = new Date(iso); return d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0'); }
            }
        }).mount('#app')
    </script>
</body>
</html>